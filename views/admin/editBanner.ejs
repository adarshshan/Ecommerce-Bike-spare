<%- include('head/header') %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <div id="page-content-wrapper">
        <div class="container" style="margin-left: 248px;">
            <div class="row mt-5">
                <div class="col-lg-7 col-md-12">
                    <div class="container">
                        <h2>Edit Banner</h2>
                        <form action="/banners/update-banner" id="bannerForm" method="post" class="shadow p-5 bg-light"
                            enctype="multipart/form-data">
                            <label for="">Title</label>
                            <input type="text" name="title" value="<%= data.title %>" id="title" class="form-control">
                            <input type="text" name="title" value="<%= data._id %>" id="id" class="form-control d-none">

                            <label for="">Select Product</label>
                            <select name="product" id="product" class="form-control">
                                <option value="<%= data.product._id %>">
                                    <%= data.product.name %>
                                </option>
                                <% for(let product of products) { %>
                                    <option value="<%= product._id %>">
                                        <%= product.name %>
                                    </option>
                                    <% } %>
                            </select>

                            <label for="">Description</label>
                            <input type="text" name="description" value="<%= data.description %>" id="description"
                                class="form-control">

                            <label for="">image</label>
                            <input type="file" name="inputImage" id="inputImage" class="form-control" multiple>
                            <input type="text" name="sameimage" id="sameimage" class="form-control  d-none"
                                value="<%= data.image_url %>">

                            <div>
                                <div>
                                    <img src="" id="croppedImage" alt="">
                                </div>

                                <% if (data.image_url) { %>
                                    <img style="width: 200px;" src="http://localhost:3000/<%= data.image_url %>"
                                        id="image" alt="">
                                    <% } %>
                            </div>

                            <label for="">Start Date</label>
                            <input type="date" name="startDate" value="<%= data.startDate %>" id="startDate"
                                class="form-control">
                            <label for="">End Date</label>
                            <input type="date" name="endDate" value="<%= data.endDate %>" id="endDate"
                                class="form-control">

                            <!-- <button onclick="addBanner()" class="btn btn-success mt-4">Add Product</button> -->
                            <button type="submit" class="btn btn-success mt-4">Add Banner</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.js"
        integrity="sha512-Zt7blzhYHCLHjU0c+e4ldn5kGAbwLKTSOTERgqSNyTB50wWSI21z0q6bn/dEIuqf6HiFzKJ6cfj2osRhklb4Og=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const input = document.getElementById('inputImage');
        const image = document.getElementById('croppedImage');
        const existImage = document.getElementById('image')
        let cropper;
        existImage.addEventListener('click', (e) => {
            existImage.style.width = '700px'
            if (cropper) {
                cropper.destroy()
            }
            cropper = new Cropper(existImage, {
                aspectRatio: 25 / 9,
            })

        })
        input.addEventListener('change', (e) => {
            const file = e.target.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    image.src = event.target.result;
                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(image, {
                        aspectRatio: 25 / 9,
                    });
                };
                reader.readAsDataURL(file);
            }
        });
        document.getElementById('bannerForm').addEventListener('submit', async (e) => {
            e.preventDefault(); 

            const formData = new FormData();
            formData.append('title', document.getElementById('title').value);
            formData.append('id', document.getElementById('id').value);
            formData.append('product', document.getElementById('product').value);
            formData.append('startDate', document.getElementById('startDate').value);
            formData.append('endDate', document.getElementById('endDate').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('sameimage', document.getElementById('sameimage').value);


            const canvas = cropper.getCroppedCanvas();
            canvas.toBlob((blob) => {
                formData.append('image', blob, 'cropped_image.jpg');

                fetch('/banners/update-banner', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error uploading banner');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            console.log('Banner added successfully:', data);
                            location.href = '/banners'
                        } else {
                            alert(data.message)
                            location.href = '/banners'
                        }

                    })
                    .catch(error => {
                        console.error('Error:', error.message);
                    });
            }, 'image/jpeg');
        });
    </script>
    <%- include('head/footer') %>