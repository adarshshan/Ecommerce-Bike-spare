<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>user-dashboard</title>
    <link rel="stylesheet" href="/static/user.css">
    <link rel="stylesheet" href="/static/user/popup.css">
    <script src="https://kit.fontawesome.com/718fa3d4ba.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<style>
    .invoice-title h2,
    .invoice-title h3 {
        display: inline-block;
    }

    .table>tbody>tr>.no-line {
        border-top: none;
    }

    .table>thead>tr>.no-line {
        border-bottom: none;
    }

    .table>tbody>tr>.thick-line {
        border-top: 2px solid;
    }
</style>

<body style="background-color: #f7efef;">

    <header>
        <nav class="navbar navbar-expand-lg navbar-light py-3 border-bottom border-3 bg-light">
            <div class="container-fluid">
                <a class="navbar-brand fs-1 fw-bold ms-4 text-danger" href="/">Spare<span
                        class="text-dark">KIT</span></a>
            </div>
        </nav>
    </header>
    <% let rupee = new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
    }); %>
    <div class="container">
        <!-- popup  -->
        <div class="popup shadow" id="popup">
            <img src="https://cdn.pixabay.com/photo/2014/04/02/11/01/tick-305245_640.png" alt="">
            <h2>Thank you</h2>
            <p id="message-alert">Your Order has placed. Thanks!</p>
            <button class="bttn" type="button" onclick="closePopup()">Ok</button>
        </div>

        <div class="row pt-3">
            <div class=" col-sm-12 col-md-12 col-lg-8 col-12">
                <div class=" p-3">
                    <div class="form-group col-md-12 p-3 bg-light text-dark">
                        <h2 class="section-title position-relative ms-4 text-uppercase mb-3" id="pay"><span
                                class="pr-3">Payment</span></h2>
                    </div>

                    <div class="bg-light p-30 shadow mb-4">
                        <form action="" id="myForm" class=" pb-4">
                            <div class="form-group col-md-12 p-3">
                                <div class="custom-control custom-radio">
                                    <input type="radio" value="COD" class="custom-control-input" name="payment" id="cod"
                                        required>
                                    <label class="custom-control-label" for="cod">Cash on delivery</label>
                                </div>
                            </div>
                            <div class="form-group col-md-12 p-3">
                                <div class="custom-control custom-radio">
                                    <input type="radio" value="online payment" class="custom-control-input"
                                        name="payment" id="onlinepayment" required>
                                    <label class="custom-control-label" for="onlinepayment">Online Payment</label>
                                </div>
                            </div>
                            <div class="form-group col-md-12 p-3">
                                <div class="custom-control custom-radio">
                                    <input type="radio" value="online payment + wallet" class="custom-control-input"
                                        name="payment" id="onlineAndwallet" required>
                                    <label class="custom-control-label" for="onlinepayment+wallet">Wallet + Online
                                        Payment</label>
                                </div>
                            </div>
                            <hr class="my-4" />
                            <span id="Errormsg" class="text-danger ms-4"></span>
                            <input type="submit" class="btn btn-outline-warning py-2 col-10 ms-5 mb-4"
                                value="Place Order">
                                
                        </form>
                        

                        <!-- <button type="submit" class="btn btn-block btn-primary font-weight-bold py-3">Place Order</button> -->
                        <!-- <button onclick="placeOrder()" id="pay-button" class="btn btn-block btn-primary font-weight-bold py-3">Place Order</button> -->
                    </div>
                </div>
            </div>
            <div class="col-sm-12 col-md-12 col-lg-4 col-12">
                <div class="card mb-4 shadow">
                    <div class="card-header py-3">
                        <h5 class="mb-0">Summary</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li
                                class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                                Price(<%= totalProducts %> items)
                                    <span id="actualamount">
                                        <%= rupee.format(totalAmount+totalDiscount) %>
                                    </span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                Discount on products
                                <span id="discount-product">
                                    <%= rupee.format(totalDiscount) %>
                                </span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span id="percentCoupon">Discount on Coupons</span>
                                <span id="discount">00</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                Shipping
                                <span>Free</span>
                            </li>
                            <li
                                class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3">
                                <div>
                                    <strong>Total amount</strong>
                                    <strong>
                                        <p class="mb-0">(including VAT)</p>
                                    </strong>
                                </div>
                                <span><strong id="totalAmount">Rs.<%= rupee.format(totalAmount)%></strong></span>
                            </li>
                        </ul>
                        <!-- coupon -->
                        <div id="couponbox">
                            <div class="card-body d-flex border-top">
                                <div class="form-group">
                                    <input type="text" class="form-control py-3 px-2" id="couponCode"
                                        placeholder="Enter coupon code">
                                </div>
                                <button id="applybtn" class="btn btn-outline-primary ms-3 px-4"
                                    onclick="verifyCoupon('<%= totalAmount %>')">Apply</button>
                                <button id="cancelbtn" style="display: none;" class="btn btn-outline-danger ms-3 px-4"
                                    onclick="cancelCoupon('<%= totalAmount %>')">Cancel</button>
                            </div>
                            <span class="text-danger" id="coupon-error"></span>
                        </div>
                        <!-- /coupon -->

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://rawgit.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="/static/user/invoice.js"></script>
    <script>
        let rupee = new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                });
        async function cancelCoupon(totalAmount) {
            const response = await fetch('/coupons/cancelCoupon', { method: 'get' })
            const resbody = await response.json()
            if (resbody.success) {
                alert(resbody.message)
                document.getElementById('cancelbtn').style.display = 'none'
                document.getElementById('applybtn').style.display = 'block'
                document.getElementById('couponCode').value = '';
                document.getElementById('coupon-error').innerHTML = '';
                document.getElementById('discount').innerText = rupee.format(0);
                document.getElementById('totalAmount').innerText = rupee.format(totalAmount);
                document.getElementById('percentCoupon').innerText = `Discount on Coupons `;
                localStorage.removeItem('CouponDetails')
            } else {
                alert(resbody.message)
            }
        }
        async function verifyCoupon(total) {
            const code = document.getElementById('couponCode').value;
            const response = await fetch(`/coupons/verify-coupon/${total}/${code}`, { method: 'get' })
            const resbody = await response.json()
            if (resbody.success) {
                let couponDetails = {
                    couponDiscount: resbody.discountAmount,
                    percentCoupon: resbody.percentCoupon,
                    actualAmount: resbody.actualAmount
                }
                localStorage.setItem("CouponDetails", JSON.stringify(couponDetails))//Storing the coupon Details in the local storrage.
                document.getElementById('totalAmount').innerText = rupee.format(resbody.actualAmount);
                document.getElementById('discount').innerText = rupee.format(resbody.discountAmount);
                document.getElementById('percentCoupon').innerText = `Discount on Coupons(${resbody.percentCoupon}%)`;
                document.getElementById('message-alert').innerText = resbody.message
                // document.getElementById('coupon-error').innerText=resbody.message
                document.getElementById('coupon-error').innerHTML = `<p class="text-success">${resbody.message}</p>`
                document.getElementById('cancelbtn').style.display = 'block'
                document.getElementById('applybtn').style.display = 'none'
                openPopup()
            } else {
                document.getElementById('coupon-error').innerText = resbody.message
            }
        }
        const storedInfo = JSON.parse(localStorage.getItem('CouponDetails'))
        if (storedInfo) {
            document.getElementById('cancelbtn').style.display = 'block'
            document.getElementById('applybtn').style.display = 'none'
            document.getElementById('discount').innerHTML = storedInfo.couponDiscount
            document.getElementById('percentCoupon').innerText = `Discount on Coupons(${storedInfo.percentCoupon}%)`;
            document.getElementById('totalAmount').innerText = storedInfo.actualAmount;
        }

    </script>



    <%- include('head/footer') %>